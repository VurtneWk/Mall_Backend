## 45、商品服务-API-三级分类-查询-递归树形结构数据获取

### 导入数据

在mysql中执行 `pms_catelog.sql` 文件数据，进行分类数据导入

其它查看代码

### 重点

- kotlin的 `asSequence()` 等于java中的 `stream()`



## 46、商品服务-API-三级分类-配置网关路由与路径重写

### 启动renren-fast后台

### 启动renren前端进行登录

### 新增一级菜单

![image-20250107012536408](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070125437.png)

![image-20250107012614844](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070126866.png)

### 新增二级菜单

![image-20250107012805926](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070128946.png)

![image-20250107012841008](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070128031.png)



![image-20250107012948767](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070129791.png)

这里的菜单URL 在renren后端中 点击分类维护时会变成请求：http://localhost:8001/#/product-category  /变成-

### 重点：前端页面点击时和代码所在位置规则

比如点击角色管理：请求的链接是 http://localhost:8001/#/sys-role 对应的是人人前端代码中的

![image-20250107013400410](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070134431.png) 

### 网关配置

```yaml
gateway:
	mvc:
		routes:
# lb 代表负载均衡 ，RewritePath 重写路径 把/api/(?<segment>.*) 重写成 /renren-fast/$\{segment}
    	- id: admin_route
    		uri: lb://renren-fast
    		predicates:
   	 			- Path=/api/**
    		filters:
    			- RewritePath=/api/(?<segment>.*), /renren-fast/$\{segment}
```

> [!caution]
>
> renren-fast是老项目,集成common后大量报错,最终修改查看pom.xml

### 异常

```xml
	<!--1-->	
	<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-gateway-mvc</artifactId>
		</dependency>
	<!--2-->	
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-gateway</artifactId>
		</dependency>
```

如果配置的是1，则异常java.lang.ClassNotFoundException: org.springframework.cloud.loadbalancer.support.LoadBalancerClientFactory

如果配置的是2，能运行，http://localhost:88/api/captcha.jpg?uuid=d367011d-60a6-4b21-810e-d6459a82f776 请求验证码图片时503

> 解决

使用的1，然后再加上以下依赖

```xml
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-loadbalancer</artifactId>
		</dependency>
```

> [!caution]
>
> 选1,2 都要加依赖，选了1导致后面 47小节 实战配置问题 大坑

## 47、商品服务-API-三级分类-网关统一配置跨域

### 跨域

指的是浏览器不能执行其他网站的脚本。它是由浏览器的同源策略造成的，是**浏览器对javascript施加的安全限制**。

**同源策略** 是指协议，域名，端口都要相同，其中有一个不同都会产生跨域；

![image-20250107065041628](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070650709.png) 

### 跨域流程

![image-20250107065222604](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070652640.png) 

https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS

### 解决跨域

#### （一）使用nginx部署为同一域

![image-20250107065637724](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070656779.png) 

#### （二）配置当次请求允许跨域

添加响应头

- Access-Control-Allow-Origin：支持哪些来源的请求跨域

- Access-Control-Allow-Methods：支持哪些方法跨域

- Access-Control-Allow-Credentials：跨域请求默认不包含cookie，设置为true可以包含cookie

- Access-Control-Expose-Headers：跨域请求暴露的字段
  - CORS请求时，XMLHttpRequest对象的getResponseHeader()方法只能拿到6个基本字段：Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma。如果想拿到其他字段，就必须在Access-Control-Expose-Headers里面指定。

- Access-Control-Max-Age：表明该响应的有效时间为多少秒。在有效时间内，浏览器无须为同一请求再次发起预检请求。请注意，浏览器自身维护了一个最大有效时间，如果该首部字段的值超过了最大有效时间，将不会生效。

### 实战配置问题

```xml
	<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-gateway-mvc</artifactId>
		</dependency>
```

导致教程配置无效，mvc的配置需要修改为

```kotlin
/**
 * 如果依赖使用的spring-cloud-starter-gateway-mvc
 * 而不是spring-cloud-starter-gateway，则需要使用这个配置
 */
@Configuration
class MallCorsMvcConfiguration : WebMvcConfigurer {

    override fun addCorsMappings(registry: CorsRegistry) {
        registry.addMapping("/**") // 匹配所有路径
            .allowedOriginPatterns("*")
//            .allowedOrigins("*") // 允许的来源
            .allowedMethods("*") // 允许的 HTTP 方法
            .allowedHeaders("*") // 允许的头
            .allowCredentials(true) // 允许携带 Cookie
    }
}
```

---

```xml
	<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-gateway</artifactId>
		</dependency>
```

则使用配置

```kotlin
@Configuration
class MallCorsConfiguration {

    @Bean
    fun corsWebFilter(): CorsWebFilter {
        val urlBasedCorsConfigurationSource = UrlBasedCorsConfigurationSource()

        val corsConfiguration = CorsConfiguration().apply {
            addAllowedHeader("*")
            addAllowedMethod("*")
//            addAllowedOrigin("*")
            addAllowedOriginPattern("*")
            addExposedHeader("*")
            allowCredentials = true
        }
        urlBasedCorsConfigurationSource.registerCorsConfiguration("/**", corsConfiguration)
        println("=======  corsWebFilter ========")
        return CorsWebFilter(urlBasedCorsConfigurationSource)
    }
}
```

> [!caution]
>
> 为了统一，去掉了MVC的依赖

## 48、商品服务-API-三级分类-查询-树形展示三级分类数据

UI按照https://element.eleme.cn/#/zh-CN/component/tree 配置即可

### 后端：

> mall-product 的网关配置

> [!note]
>
> 注意网关顺序，如果admin_route在前面，当单独请求http://localhost:88/api/product/category/list/tree时，会被权限拦截

```yaml
        - id: product_route
          uri: lb://mall-product
          predicates:
            - Path=/api/product/**
          filters:
            - RewritePath=/api/(?<segment>.*), /$\{segment}

        # lb 代表负载均衡 ，RewritePath 重写路径 把/api/(?<segment>.*) 重写成 /renren-fast/$\{segment}
        # http://localhost:88/api/captcha.jpg  http://localhost:8080/renren-fast/captcha.jpg
        - id: admin_route
          uri: lb://renren-fast
          predicates:
            - Path=/api/**  #路由匹配有顺序，所以让更精确的在上面
          filters:
            - RewritePath=/api/(?<segment>.*), /renren-fast/$\{segment}
```

## 49、商品服务-API-三级分类-删除-页面效果

主要是前端Element UI的使用

```vue
<script>
export default {
  data () {
    return {
      menus: [],
      defaultProps: {
        children: 'childrenList',
        label: 'name'
      }
    }
  },
  methods: {
    getMenus () {
      this.$http({
        url: this.$http.adornUrl('/product/category/list/tree'),
        method: 'get'
      }).then(({data}) => {
        console.log('成功获取到菜单数据...', data.data)
        this.menus = data.data
      })
    },
    append (data) {
      console.log('append', data)
    },

    remove (node, data) {
      console.log('remove', node, data)
    }
  },
  created () {
    this.getMenus()
  }
}
</script>

<template>
  <el-tree :data="menus" :props="defaultProps"
           :expand-on-click-node="false" show-checkbox
            node-key="catId">
     <span class="custom-tree-node" slot-scope="{ node, data }">
        <span>{{ node.label }}</span>
        <span>
          <el-button
            v-if="node.level <= 2"
            type="text"
            size="mini"
            @click="() => append(data)">
            Append
          </el-button>
          <el-button
            v-if="node.childNodes.length === 0"
            type="text"
            size="mini"
            @click="() => remove(node, data)">
            Delete
          </el-button>
        </span>
     </span>
  </el-tree>
</template>

<style scoped lang="scss">

</style>
```

## 50、商品服务-API-三级分类-删除-逻辑删除

### mybatis plus逻辑删除

https://baomidou.com/guides/logic-delete/

> 全局配置 （也可以不加）

```yaml
mybatis-plus:
  global-config:
    db-config:
      logic-delete-field: deleted # 全局逻辑删除字段名
      logic-delete-value: 1 # 逻辑已删除值
      logic-not-delete-value: 0 # 逻辑未删除值
```

> 配置entity

```kotlin
/**
     * 是否显示[0-不显示，1显示]
     */
@TableLogic(value = "1", delval = "0")
var showStatus: Int? = null,
```

> mall product application.yaml 可配置日志级别进行测试

```yaml
logging:
  level:
    com.vurtnewk.mall: debug
```

```tex
[mall-product]  : ==>  Preparing: UPDATE pms_category SET show_status=0 WHERE cat_id IN ( ? ) AND show_status=1
[mall-product]  : ==> Parameters: 1431(Long)
[mall-product]  : <==    Updates: 1
```

删除的语句变成了更新

## 51、商品服务-API-三级分类-删除-删除效果细化 - 58、商品服务-API-三级分类-删除-批量删除&小结

前端 略

## 59、商品服务-API-品牌管理-使用逆向工程的前后端代码

直接复制逆向生成的前端代码

procut里的 `brand-add-or-update.vue` `brand.vue` copy到前端项目

### 没有 "新增"、"批量删除" 按钮

因为权限不够

```vue
<el-button v-if="isAuth('product:brand:save')" type="primary" @click="addOrUpdateHandle()">新增</el-button>
<el-button v-if="isAuth('product:brand:delete')" type="danger" @click="deleteHandle()" :disabled="dataListSelections.length <= 0">批量删除</el-button>
```

根据 `isAuth` 搜索找到

```js
/**
 * 是否有权限
 * @param {*} key
 */
export function isAuth (key) {
  return JSON.parse(sessionStorage.getItem('permissions') || '[]').indexOf(key) !== -1 || false
}
```

先直接注释掉后返回true

![image-20250107181804214](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501071818305.png)

## 60、商品服务-API-品牌管理-效果优化与快速显示开关

el-switch 的使用

## 61、商品服务-API-品牌管理-云存储开通与使用

### 文件存储

![image-20250107193030484](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501071930592.png) 

### 注册开通阿里云 对象存储 OSS

### 上传方式

#### 方式一

![image-20250107195348540](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501071953726.png) 

#### 方式二

![image-20250107195333465](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501071953552.png) 

## 62、商品服务-API-品牌管理-OSS整合测试

使用alibaba cloud oss

https://github.com/alibaba/aliyun-spring-boot/blob/master/aliyun-spring-boot-samples/aliyun-oss-spring-boot-sample/README-zh.md

## 63、商品服务-API-品牌管理-OSS获取服务端签名

### 版本问题

#### 方式一 

ali oss 有提供starter 版本

```xml
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alicloud-oss</artifactId>
        </dependency>
```

但是没更新，所以启动有问题，如果要使用需要降级spring boot 、jdk等，具体查看`backuppom.xml`文件

#### 方式二

直接使用提供的SDK 版本

```xml
        <dependency>
            <groupId>com.aliyun.oss</groupId>
            <artifactId>aliyun-sdk-oss</artifactId>
            <version>3.18.1</version>
        </dependency>
```

缺点1. 是没加入到spring 中，需要手动配置,不然不能DI

```kotlin
@Configuration
@RefreshScope
class AliyunOssConfiguration {


    @Value("\${endpoint}")
    private lateinit var endpoint: String

    @Value("\${accessKeyId}")
    private lateinit var accessKeyId: String

    @Value("\${accessKeySecret}")
    private lateinit var accessKeySecret: String

    @Bean
    fun ossClient(): OSS {
        val build = OSSClientBuilder().build(endpoint, accessKeyId, accessKeySecret)
        return build
    }
}
```

> [!caution]
>
> 默认情况 方式一 提供的自动注入 也只有接口类型OSS

缺点2.配置文件里的就无效了

> [!note]
>
> 为了安全起见，endpoint、accessKeyId、accessKeySecret 等数据使用了nacos配置中心。通过配置中心获取。
>
> ```yaml
> spring:
>   cloud:
>     nacos:
>       discovery:
>         server-addr: 127.0.0.1:8848
>       config:
>         server-addr: 127.0.0.1:8848
>   config:
>     import:
>       - nacos:third-party.properties?refreshEnabled=true&group=DEFAULT_GROUP
>   # 如果没有名字，nacos里看不到
>   application:
>     name: mall-thrid-party
> 
> 
> server:
>   port: 5600
> 
> ```
>
> (如果数据被删了，在有道笔记中有备份)
>
> ![image-20250108091843173](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501080918293.png)

### 给前端提供签名

提供签名后由前端直接提交图片到OSS,而不是把图片上传到应用服务器

```kotlin
package com.vurtnewk.mall.third_party.controller

import com.aliyun.oss.OSS
import com.aliyun.oss.common.utils.BinaryUtil
import com.aliyun.oss.model.MatchMode
import com.aliyun.oss.model.PolicyConditions
import com.vurtnewk.common.utils.R
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.beans.factory.annotation.Value
import org.springframework.web.bind.annotation.RequestMapping
import org.springframework.web.bind.annotation.RestController
import java.text.SimpleDateFormat
import java.util.*

/**
 * createTime:  2025/1/7 20:50
 * author:      vurtnewk
 * description: 文件上传 ， 返回验证，由前端直接上传到oss
 */
@RestController
class OssController {
    @Autowired
    var ossClient: OSS? = null

    @Value("\${endpoint}")
    private val endpoint: String? = null

    @Value("\${bucket}")
    private val bucket: String? = null

    @Value("\${accessKeyId}")
    private val accessId: String? = null

    @RequestMapping("/oss/policy")
    fun policy(): R {
        // host的格式为 bucketname.endpoint   用于拼接图片的访问地址
        val host = "https://$bucket.$endpoint"

        // 用户上传文件时指定的前缀。  此处定义每天建立一个文件夹
        val format = SimpleDateFormat("yyyy-MM-dd").format(Date())
        val dir = "$format/"
        var respMap: MutableMap<String?, String?>? = null
        try {
            val expireTime: Long = 30
            val expireEndTime = System.currentTimeMillis() + expireTime * 1000
            val expiration = Date(expireEndTime)
            // PostObject请求最大可支持的文件大小为5 GB，即CONTENT_LENGTH_RANGE为5*1024*1024*1024。
            val policyConds = PolicyConditions()
            policyConds.addConditionItem(PolicyConditions.COND_CONTENT_LENGTH_RANGE, 0, 1048576000)
            policyConds.addConditionItem(MatchMode.StartWith, PolicyConditions.COND_KEY, dir)
            val postPolicy = ossClient!!.generatePostPolicy(expiration, policyConds)
            val binaryData = postPolicy.toByteArray(charset("utf-8"))
            val encodedPolicy = BinaryUtil.toBase64String(binaryData)
            val postSignature = ossClient!!.calculatePostSignature(postPolicy)
            respMap = LinkedHashMap()
            respMap["accessid"] = accessId
            respMap["policy"] = encodedPolicy
            respMap["signature"] = postSignature
            respMap["dir"] = dir
            respMap["host"] = host
            respMap["expire"] = (expireEndTime / 1000).toString()
        } catch (e: Exception) {
            // Assert.fail(e.getMessage());
            println(e.message)
        } finally {
            ossClient!!.shutdown()
        }
        return R.ok().put("data", respMap!!)
    }

}
```

#### 测试

http://127.0.0.1:5600/oss/policy

```json
{
    "msg": "success",
    "code": 0,
    "data": {
        "accessid": "LTAI5t8xzfjUunKMK9ARd8nk",
        "policy": "eyJleHBpcmF0aW9uIjoiMjAyNS0wMS0wOFQwMToyNToyMC4zNDFaIiwiY29uZGl0aW9ucyI6W1siY29udGVudC1sZW5ndGgtcmFuZ2UiLDAsMTA0ODU3NjAwMF0sWyJzdGFydHMtd2l0aCIsIiRrZXkiLCIyMDI1LTAxLTA4XC8iXV19",
        "signature": "idcXMwTnVqqJBct8XCOLt0eFaAA=",
        "dir": "2025-01-08/",
        "host": "https://mall-vurtnewk.oss-cn-beijing.aliyuncs.com",
        "expire": "1736299520"
    }
}
```

### 加入网关

```yaml
        - id: third_party_route
          uri: lb://mall-third-party
          predicates:
            - Path=/api/thirdparty/**
          filters:
            - RewritePath=/api/thirdparty/(?<segment>.*),/$\{segment}
```

再次测试：http://127.0.0.1:88/api/thirdparty/oss/policy

## 64、商品服务-API-品牌管理-OSS前后联调测试上传

### 注意点

- 阿里OSS 需要开启能跨域访问

![image-20250108101947724](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501081019862.png) 

### 使用

> 导入了已经写好的上传模板

![image-20250108102018694](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501081020826.png) 

> 修改action 上传地址：  action="http://mall-vurtnewk.oss-cn-beijing.aliyuncs.com"

> 在使用的地方导入

```vue
import SingleUpload from "@/components/upload/singleUpload";
export default {
components: { SingleUpload },
}
<!-- 使用 -->
<el-form-item label="品牌logo地址" prop="logo">
  <!-- <el-input v-model="dataForm.logo" placeholder="品牌logo地址"></el-input> -->
  <single-upload v-model="dataForm.logo"></single-upload>
</el-form-item>
```

## 65、商品服务-API-品牌管理-表单校验&自定义校验器

### 前端校验

brand-add-or-update.vue 

https://element.eleme.cn/#/zh-CN/component/form

## 66、商品服务-API-品牌管理-JSR303数据校验

### 后端校验

> 导包 common pom.xml

```xml
        <!--     自定义jsr303 规则需要导入的包
           这个没有 URL 规则
           -->
<!--        <dependency>-->
<!--            <groupId>jakarta.validation</groupId>-->
<!--            <artifactId>jakarta.validation-api</artifactId>-->
<!--            <version>3.1.0</version>-->
<!--            <scope>compile</scope>-->
<!--        </dependency>-->
<!--   这个里包含 hibernate-validator ，有URL规则    -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
            <version>3.4.1</version>
        </dependency>
```

> 在要验证的字段上添加 注解

```kotlin
@TableName("pms_brand")
data class BrandEntity(
    /**
     * 品牌id
     */
    @TableId
    var brandId: Long? = null,
    /**
     * 品牌名
     */
    @NotBlank
    var name: String? = null,
```

> 在controller上开启验证 @Valid

```kotlin
    @RequestMapping("/save")
    //@RequiresPermissions("product:brand:save")
    fun save(@Valid @RequestBody brand: BrandEntity): R {
            brandService.save(brand)
        return R.ok()
    }
```

### 坑

调用时@Valid不生效，原因是kotlin写的

需要改为：

```kotlin
package com.vurtnewk.mall.product.entity

import com.baomidou.mybatisplus.annotation.TableId
import com.baomidou.mybatisplus.annotation.TableName
import jakarta.validation.constraints.Min
import jakarta.validation.constraints.NotBlank
import jakarta.validation.constraints.NotEmpty
import jakarta.validation.constraints.NotNull
import jakarta.validation.constraints.Pattern
import org.hibernate.validator.constraints.URL
import java.io.Serializable

/**
 * 品牌
 *
 * @author vurtnewk
 * @email vurtnewk@gmail.com
 * @date 2025-01-06 12:58:45
 */
@TableName("pms_brand")
data class BrandEntity(
    /**
     * 品牌id
     */
    @TableId
    var brandId: Long? = null,
    /**
     * 品牌名
     */
    @field:NotBlank(message = "品牌名不能为空")
    var name: String = "",
    /**
     * 品牌logo地址
     */
    @field:URL(message = "logo必须是一个合法的url地址")
    @field:NotEmpty
    var logo: String = "",
    /**
     * 介绍
     */
    var descript: String = "",
    /**
     * 显示状态[0-不显示；1-显示]
     */
    var showStatus: Int = 1,
    /**
     * 检索首字母
     */
    @field:NotEmpty
    @field:Pattern(regexp = "/^[a-zA-Z]$/", message = "检索首字母必须是一个字母")
    var firstLetter: String = "",
    /**
     * 排序
     */
    @field:NotNull
    @field:Min(value = 0, message = "排序必须大于等于0")
    var sort: Int = 0,
) : Serializable {
    companion object {
        @JvmStatic
        val serialVersionUID: Long = 1L
    }
}
```

## 67、商品服务-API-品牌管理-统一异常处理

```kotlin
package com.vurtnewk.mall.product.excetion

import com.vurtnewk.common.excetion.BizCodeEnum
import com.vurtnewk.common.utils.R
import org.springframework.validation.FieldError
import org.springframework.web.bind.MethodArgumentNotValidException
import org.springframework.web.bind.annotation.ExceptionHandler
import org.springframework.web.bind.annotation.RestControllerAdvice
import java.util.HashMap
import java.util.function.Consumer

/**
 * createTime:  2025/1/8 12:37
 * author:      vurtnewk
 * description: 统一异常处理
 */
@RestControllerAdvice(basePackages = ["com.vurtnewk.mall.product.controller"])
class MallProductExceptionControllerAdvice {
    /**
     * 用于JSR303校验异常时的数据返回
     */
    @ExceptionHandler(value = [MethodArgumentNotValidException::class])
    fun handleValidException(e: MethodArgumentNotValidException): R {
        val map: MutableMap<String, String?> = HashMap()
        e.bindingResult.fieldErrors.forEach(Consumer { item: FieldError ->
            map[item.field] = item.defaultMessage
        })
        return R.error(BizCodeEnum.VALID_EXCEPTION.code, BizCodeEnum.VALID_EXCEPTION.msg).put("data", map)
    }


    @ExceptionHandler(value = [Throwable::class])
    fun handleException(): R {
        return R.error(BizCodeEnum.UNKNOWN_EXCEPTION.code, BizCodeEnum.UNKNOWN_EXCEPTION.msg)
    }
}
```

```kotlin
package com.vurtnewk.common.excetion

/**
 * createTime:  2025/1/8 12:41
 * author:      vurtnewk
 * description:
 */
enum class BizCodeEnum(
    val code: Int,
    val msg: String
) {
    UNKNOWN_EXCEPTION(10000, "系统位置异常"),
    VALID_EXCEPTION(10001, "参数格式校验失败");

}
```