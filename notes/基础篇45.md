## 45、商品服务-API-三级分类-查询-递归树形结构数据获取

### 导入数据

在mysql中执行 `pms_catelog.sql` 文件数据，进行分类数据导入

其它查看代码

### 重点

- kotlin的 `asSequence()` 等于java中的 `stream()`



## 46、商品服务-API-三级分类-配置网关路由与路径重写

### 启动renren-fast后台

### 启动renren前端进行登录

### 新增一级菜单

![image-20250107012536408](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070125437.png)

![image-20250107012614844](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070126866.png)

### 新增二级菜单

![image-20250107012805926](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070128946.png)

![image-20250107012841008](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070128031.png)



![image-20250107012948767](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070129791.png)

这里的菜单URL 在renren后端中 点击分类维护时会变成请求：http://localhost:8001/#/product-category  /变成-

### 重点：前端页面点击时和代码所在位置规则

比如点击角色管理：请求的链接是 http://localhost:8001/#/sys-role 对应的是人人前端代码中的

![image-20250107013400410](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070134431.png) 

### 网关配置

```yaml
gateway:
	mvc:
		routes:
# lb 代表负载均衡 ，RewritePath 重写路径 把/api/(?<segment>.*) 重写成 /renren-fast/$\{segment}
    	- id: admin_route
    		uri: lb://renren-fast
    		predicates:
   	 			- Path=/api/**
    		filters:
    			- RewritePath=/api/(?<segment>.*), /renren-fast/$\{segment}
```

> [!caution]
>
> renren-fast是老项目,集成common后大量报错,最终修改查看pom.xml

### 异常

```xml
	<!--1-->	
	<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-gateway-mvc</artifactId>
		</dependency>
	<!--2-->	
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-gateway</artifactId>
		</dependency>
```

如果配置的是1，则异常java.lang.ClassNotFoundException: org.springframework.cloud.loadbalancer.support.LoadBalancerClientFactory

如果配置的是2，能运行，http://localhost:88/api/captcha.jpg?uuid=d367011d-60a6-4b21-810e-d6459a82f776 请求验证码图片时503

> 解决

使用的1，然后再加上以下依赖

```xml
		<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-loadbalancer</artifactId>
		</dependency>
```

> [!caution]
>
> 选1,2 都要加依赖，选了1导致后面 47小节 实战配置问题 大坑

## 47、商品服务-API-三级分类-网关统一配置跨域

### 跨域

指的是浏览器不能执行其他网站的脚本。它是由浏览器的同源策略造成的，是**浏览器对javascript施加的安全限制**。

**同源策略** 是指协议，域名，端口都要相同，其中有一个不同都会产生跨域；

![image-20250107065041628](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070650709.png) 

### 跨域流程

![image-20250107065222604](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070652640.png) 

https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS

### 解决跨域

#### （一）使用nginx部署为同一域

![image-20250107065637724](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501070656779.png) 

#### （二）配置当次请求允许跨域

添加响应头

- Access-Control-Allow-Origin：支持哪些来源的请求跨域

- Access-Control-Allow-Methods：支持哪些方法跨域

- Access-Control-Allow-Credentials：跨域请求默认不包含cookie，设置为true可以包含cookie

- Access-Control-Expose-Headers：跨域请求暴露的字段
  - CORS请求时，XMLHttpRequest对象的getResponseHeader()方法只能拿到6个基本字段：Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma。如果想拿到其他字段，就必须在Access-Control-Expose-Headers里面指定。

- Access-Control-Max-Age：表明该响应的有效时间为多少秒。在有效时间内，浏览器无须为同一请求再次发起预检请求。请注意，浏览器自身维护了一个最大有效时间，如果该首部字段的值超过了最大有效时间，将不会生效。

### 实战配置问题

```xml
	<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-gateway-mvc</artifactId>
		</dependency>
```

导致教程配置无效，mvc的配置需要修改为

```kotlin
/**
 * 如果依赖使用的spring-cloud-starter-gateway-mvc
 * 而不是spring-cloud-starter-gateway，则需要使用这个配置
 */
@Configuration
class MallCorsMvcConfiguration : WebMvcConfigurer {

    override fun addCorsMappings(registry: CorsRegistry) {
        registry.addMapping("/**") // 匹配所有路径
            .allowedOriginPatterns("*")
//            .allowedOrigins("*") // 允许的来源
            .allowedMethods("*") // 允许的 HTTP 方法
            .allowedHeaders("*") // 允许的头
            .allowCredentials(true) // 允许携带 Cookie
    }
}
```

---

```xml
	<dependency>
			<groupId>org.springframework.cloud</groupId>
			<artifactId>spring-cloud-starter-gateway</artifactId>
		</dependency>
```

则使用配置

```kotlin
@Configuration
class MallCorsConfiguration {

    @Bean
    fun corsWebFilter(): CorsWebFilter {
        val urlBasedCorsConfigurationSource = UrlBasedCorsConfigurationSource()

        val corsConfiguration = CorsConfiguration().apply {
            addAllowedHeader("*")
            addAllowedMethod("*")
//            addAllowedOrigin("*")
            addAllowedOriginPattern("*")
            addExposedHeader("*")
            allowCredentials = true
        }
        urlBasedCorsConfigurationSource.registerCorsConfiguration("/**", corsConfiguration)
        println("=======  corsWebFilter ========")
        return CorsWebFilter(urlBasedCorsConfigurationSource)
    }
}
```

> [!caution]
>
> 为了统一，去掉了MVC的依赖

## 48、商品服务-API-三级分类-查询-树形展示三级分类数据

按照https://element.eleme.cn/#/zh-CN/component/tree 配置即可

