

## 20、分布式组件-SpringCloud Alibaba简介

![image-20250106151359733](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501061513760.png) 

**SpringClouid的几大痛点：**

SpringCloud部分组件停止维护和更新，给开发带来不便;

SpringCloud部分环境搭建复杂，没有完善的可视化界面，我们需要大量的二次开发和定制

SpringCloud配置复杂，难以上手，部分配置差别难以区分和合理应用



**SpringCloud Alibaba的优势：**

阿里使用过的组件经历了考验，性能强悍，设计合理，现在开源出来大家用

成套的产品搭配完善的可视化界面给开发运维带来极大的便利

搭建简单，学习曲线低。



**结合SpringCloud Alibaba我们最终的技术搭配方案：**

SpringCloud Alibaba - Nacos : 注册中心 (服务发现/注册)

SpringCloud Alibaba- Nacos: 配置中心 (动态配置管理)

SpringCloud - Ribbon: 负载均衡

SpringCloud - Feign: 声明式HTTP客户端(调用远程服务)

SpringCloud Alibaba - Sentinel: 服务容错(限流、降级、熔断)

SpringCloud - Gateway:  API 网关 (webflux 编程模式)

SpringCloud - Sleuth:调用链监控

SpringCloud Alibaba - Seata: 原Fescar, 即分布式事务解决方案



> [!caution]
>
> 注意版本选择
>
> https://spring.io/projects/spring-cloud-alibaba 
>
> https://github.com/alibaba/spring-cloud-alibaba/blob/2023.x/README-zh.md
>
> https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E

> mall_common pom.xml

```xml
<!--alibaba 的微服务解决方案 -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>com.alibaba.cloud</groupId>
                <artifactId>spring-cloud-alibaba-dependencies</artifactId>
                <version>2023.0.1.0</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

```

## 21、分布式组件-SpringCloud Alibaba-Nacos注册中心

### Nacos [作为注册中心]

> common pom.xml 添加依赖

```xml
<!--服务注册/发现-->
<dependency>
  <groupId>com.alibaba.cloud</groupId>
  <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
<!--   配置中心     -->
<dependency>
  <groupId>com.alibaba.cloud</groupId>
  <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```

#### 下载 

推荐在 Spring Cloud Alibaba 2023.x 中使用 Nacos Server 2.4.2 版本

> [!note]
>
> slim 为精简镜像版本

```shell
docker pull nacos/nacos-server:v2.4.2-slim
```

#### 运行

```shell
docker volume create nacos-logs
docker volume create nacos-custom-properties

docker run \
--name nacos -d \
-p 8848:8848 \
-p 9848:9848 \
--privileged=true \
-e JVM_XMS=512m \
-e JVM_XMX=512m \
-e MODE=standalone \
-e PREFER_HOST_MODE=hostname \
-v nacos-logs:/home/nacos/logs \
-v nacos-custom-properties:/home/nacos/init.d/custom.properties \
nacos/nacos-server:v2.4.2-slim
```

> [!caution]
>
> 不知道是版本问题 还是源码的运行有问题，之前的运行没有 -p 9848端口，所以运行会出错
>
> 新增了-p 9848:9848 \

#### 项目配置

> application.yml

```yaml
spring:
  datasource:
    username: root
    password: 123456
    url: jdbc:mysql://127.0.0.1:3306/mall_ums
    driver-class-name: com.mysql.jdbc.Driver
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
  application:
    name: mall-member
```

> xxxApplication.kt

```kotlin
@EnableDiscoveryClient //新增这个
@SpringBootApplication
class MallMemberApplication

fun main(args: Array<String>) {
    runApplication<MallMemberApplication>(*args)
}

```

> 运行查看结果

![image-20250106183513250](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501061835340.png) 

## 22、分布式组件-SpringCloud-OpenFeign测试远程调用

### 测试：member服务调用coupon服务的接口

> coupon CouponController 用于测试的方法

```kotlin
    
		@RequestMapping("/member/list")
    fun memberCoupons(): R{
        val couponEntity = CouponEntity()
        couponEntity.couponName = "满100减10"
        return R.ok().put("coupons", listOf(couponEntity))
    }
```

### 引入依赖

引入依赖后即有了远程调用其它远程服务的能力

> member pom.xml 

之前创建项目时已经引入

```xml
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
```

### 编写接口

> member feign CouponFeignService

```kotlin
// 远程客户端
// mall_coupon 注册中心的名字
@FeignClient("mall_coupon")
interface CouponFeignService {

    //复制的coupon里的CouponController的方法签名
    @RequestMapping("coupon/coupon/member/list")
    fun memberCoupons(): R

}
```

> member MemberController

```kotlin
@RestController
@RequestMapping("member/member")
class MemberController @Autowired constructor(
    private val memberService: MemberService,
    private val couponFeignService: CouponFeignService
) {

    @RequestMapping("/coupons")
    fun test(): R {
        val entity = MemberEntity()
        entity.nickname = "张三"
        val r = couponFeignService.memberCoupons()
        return R.ok().put("member", entity).put("coupons", r.get("coupons")!!)
    }
}
```

### 开启远程调用

```kotlin
@EnableFeignClients(basePackages = ["com.vurtnewk.mall.member.feign"]) //扫描位置
@EnableDiscoveryClient
@SpringBootApplication
class MallMemberApplication
```

### 运行报错

https://www.cnblogs.com/yiMro/p/16018149.html

> member pom.xml

```xml
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-loadbalancer</artifactId>
        </dependency>
```

和上面的文章修改有出入，我只新增了上面的配置

## 23、分布式组件-SpringCloud Alibaba-Nacos配置中心-简单示例

### 添加依赖

> common pom.xml

```xml
        <!--   配置中心     -->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
        </dependency>
```

### 创建配置文件

![image-20250106211154259](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501062111437.png) 

![image-20250106211214164](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501062112188.png) 

### 修改配置

```yaml
spring:
  datasource:
    username: root
    password: 123456
    url: jdbc:mysql://127.0.0.1:3306/mall_sms
    driver-class-name: com.mysql.cj.jdbc.Driver
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
      config:
        server-addr: 127.0.0.1:8848
  application:
    name: mall-coupon
  config:
    import:
      - nacos:mall-coupon.properties?refreshEnabled=true&group=DEFAULT_GROUP
```

### 代码测试

> CouponController

```kotlin
@RestController
@RequestMapping("coupon/coupon")
@RefreshScope //**** 刷新配置
class CouponController @Autowired constructor(
    private val couponService: CouponService
) {

    @Value("\${coupon.user.name}")
    private var name: String = "defaultName"

    @Value("\${coupon.user.age}")
    private var age: Int = 0

    @RequestMapping("/test")
    fun test(): R {
        return R.ok().put("name", name).put("age", age)
    }
}
```

### 运行测试

> http://127.0.0.1:5001/coupon/coupon/test

返回结果

```json
{
    "msg": "success",
    "code": 0,
    "name": "223z",
    "age": 22
}
```

### 版本不同的错误

1. 配置不同

```yaml
  config:
    import:
      - nacos:mall-coupon.properties?refreshEnabled=true&group=DEFAULT_GROUP
```

不加会运行报错，可以通过忽略检查或者可选等方式去掉

2. 默认值的情况

> application.properties

```properties
coupon.user.name=zhangsan
coupon.user.age=18
```

这个有值的情况下，教程中优先使用nacos，而我的优秀使用了本地的值

3. bootstrap.properties

教程有使用这个，我都是在application.yml里进行的配置

## 24、分布式组件-SpringCloud Alibaba-Nacos配置中心-命名空间与配置分组

### 命名空间

> [!caution]
>
> nacos v2.4.2 新增没反应

## 25、分布式组件-SpringCloud Alibaba-Nacos配置中心-加载多配置集

> [!caution]
>
> 因为上面的没反应，所以24/25略过

## 26、分布式组件-SpringCloud-Gateway网关核心概念&原理

![image-20250106214328436](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501062143523.png) 

![image-20250106214340230](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501062143307.png) 

网关作为流浪入口，常用功能包括路由转发，权限效验，限流控制等，而 SpringCloud GateWay作为 SpringCloud 官方推出的第二代网关框架，取代了 Zull 网关。

网关提供 API 全托管服务，丰富的 API 管理功能，辅助企业管理大规模的 API，以降低管理成本和安全风险、包括协议适配、协议转发、安全策略、防刷、流量、监控日志等功能

Spring Cloud GateWay 旨在提供一种简单有效的方式来对 API 进行路由，并为他们提供切面，列如、安全性、监控/指标 和弹性等。

官网：https://spring.io/projects/spring-cloud-gateway#learn

## 27、分布式组件-SpringCloud-Gateway-创建&测试API网关

### 创建mall_gateway模块

- 直接选择spring模块
- 勾选gateway功能

### 配置基础

> application.yml

```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
      config:
        import-check:
          enabled: false
  # 如果没有名字，nacos里看不到
  application:
    name: mall-gateway
server:
  port: 88
```

> mall_gateway pom.xml

```xml
		<dependency>
			<groupId>com.vurtnewk.mall</groupId>
			<artifactId>mall_common</artifactId>
			<version>1.0-SNAPSHOT</version>
		</dependency>
```

> mall_gateway MallGatewayApplication

```kotlin
@EnableDiscoveryClient
@SpringBootApplication
class MallGatewayApplication

fun main(args: Array<String>) {
	runApplication<MallGatewayApplication>(*args)
}
```

### 运行错误

> Description:
>
> Failed to configure a DataSource: 'url' attribute is not specified and no embedded datasource could be configured.
>
> Reason: Failed to determine a suitable driver class
>
>
> Action:
>
> Consider the following:
> 	If you want an embedded database (H2, HSQL or Derby), please put it on the classpath.
> 	If you have database settings to be loaded from a particular profile you may need to activate it (no profiles are currently active).

因为mall_common里有数据源相关的配置，而网关模块没有使用

#### 解决方案

> mall_gateway MallGatewayApplication

```kotlin
@EnableDiscoveryClient
//排除数据库相关模块
@SpringBootApplication(exclude = [DataSourceAutoConfiguration::class])
//@SpringBootApplication
class MallGatewayApplication

fun main(args: Array<String>) {
	runApplication<MallGatewayApplication>(*args)
}
```

### 配置网关

> gateway application.yml

```yaml
spring:
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
      config:
        import-check:
          enabled: false
    gateway:
      mvc:
        routes:
          - id: test_route
            uri: https://www.baidu.com
            predicates:
              - Query=url, baidu
          - id: qq_route
            uri: https://www.qq.com
            predicates:
            - Query=url, qq
```

访问 

```tex
http://127.0.0.1:88/?url=baidu
http://127.0.0.1:88/?url=qq
```

则会进行baidu和qq的跳转

