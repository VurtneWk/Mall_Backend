

## 20、分布式组件-SpringCloud Alibaba简介

![image-20250106151359733](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501061513760.png) 

**SpringClouid的几大痛点：**

SpringCloud部分组件停止维护和更新，给开发带来不便;

SpringCloud部分环境搭建复杂，没有完善的可视化界面，我们需要大量的二次开发和定制

SpringCloud配置复杂，难以上手，部分配置差别难以区分和合理应用



**SpringCloud Alibaba的优势：**

阿里使用过的组件经历了考验，性能强悍，设计合理，现在开源出来大家用

成套的产品搭配完善的可视化界面给开发运维带来极大的便利

搭建简单，学习曲线低。



**结合SpringCloud Alibaba我们最终的技术搭配方案：**

SpringCloud Alibaba - Nacos : 注册中心 (服务发现/注册)

SpringCloud Alibaba- Nacos: 配置中心 (动态配置管理)

SpringCloud - Ribbon: 负载均衡

SpringCloud - Feign: 声明式HTTP客户端(调用远程服务)

SpringCloud Alibaba - Sentinel: 服务容错(限流、降级、熔断)

SpringCloud - Gateway:  API 网关 (webflux 编程模式)

SpringCloud - Sleuth:调用链监控

SpringCloud Alibaba - Seata: 原Fescar, 即分布式事务解决方案



> [!caution]
>
> 注意版本选择
>
> https://spring.io/projects/spring-cloud-alibaba 
>
> https://github.com/alibaba/spring-cloud-alibaba/blob/2023.x/README-zh.md
>
> https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E

> mall_common pom.xml

```xml
<!--alibaba 的微服务解决方案 -->
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>com.alibaba.cloud</groupId>
                <artifactId>spring-cloud-alibaba-dependencies</artifactId>
                <version>2023.0.1.0</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

```

## 21、分布式组件-SpringCloud Alibaba-Nacos注册中心

### Nacos [作为注册中心]

> common pom.xml 添加依赖

```xml
<!--服务注册/发现-->
<dependency>
  <groupId>com.alibaba.cloud</groupId>
  <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
<!--   配置中心     -->
<dependency>
  <groupId>com.alibaba.cloud</groupId>
  <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
```

#### 下载 

推荐在 Spring Cloud Alibaba 2023.x 中使用 Nacos Server 2.4.2 版本

> [!note]
>
> slim 为精简镜像版本

```shell
docker pull nacos/nacos-server:v2.4.2-slim
```

#### 运行

```shell
docker volume create nacos-logs
docker volume create nacos-custom-properties

docker run \
--name nacos -d \
-p 8848:8848 \
-p 9848:9848 \
--privileged=true \
-e JVM_XMS=512m \
-e JVM_XMX=512m \
-e MODE=standalone \
-e PREFER_HOST_MODE=hostname \
-v nacos-logs:/home/nacos/logs \
-v nacos-custom-properties:/home/nacos/init.d/custom.properties \
nacos/nacos-server:v2.4.2-slim
```

> [!caution]
>
> 不知道是版本问题 还是源码的运行有问题，之前的运行没有 -p 9848端口，所以运行会出错
>
> 新增了-p 9848:9848 \

#### 项目配置

> application.yml

```yaml
spring:
  datasource:
    username: root
    password: 123456
    url: jdbc:mysql://127.0.0.1:3306/mall_ums
    driver-class-name: com.mysql.jdbc.Driver
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
  application:
    name: mall-member
```

> xxxApplication.kt

```kotlin
@EnableDiscoveryClient //新增这个
@SpringBootApplication
class MallMemberApplication

fun main(args: Array<String>) {
    runApplication<MallMemberApplication>(*args)
}

```

> 运行查看结果

![image-20250106183513250](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501061835340.png) 

## 22、分布式组件-SpringCloud-OpenFeign测试远程调用

### 测试：member服务调用coupon服务的接口

> coupon CouponController 用于测试的方法

```kotlin
    
		@RequestMapping("/member/list")
    fun memberCoupons(): R{
        val couponEntity = CouponEntity()
        couponEntity.couponName = "满100减10"
        return R.ok().put("coupons", listOf(couponEntity))
    }
```

### 引入依赖

引入依赖后即有了远程调用其它远程服务的能力

> member pom.xml 

之前创建项目时已经引入

```xml
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
```

### 编写接口

> member feign CouponFeignService

```kotlin
// 远程客户端
// mall_coupon 注册中心的名字
@FeignClient("mall_coupon")
interface CouponFeignService {

    //复制的coupon里的CouponController的方法签名
    @RequestMapping("coupon/coupon/member/list")
    fun memberCoupons(): R

}
```

> member MemberController

```kotlin
@RestController
@RequestMapping("member/member")
class MemberController @Autowired constructor(
    private val memberService: MemberService,
    private val couponFeignService: CouponFeignService
) {

    @RequestMapping("/coupons")
    fun test(): R {
        val entity = MemberEntity()
        entity.nickname = "张三"
        val r = couponFeignService.memberCoupons()
        return R.ok().put("member", entity).put("coupons", r.get("coupons")!!)
    }
}
```

### 开启远程调用

```kotlin
@EnableFeignClients(basePackages = ["com.vurtnewk.mall.member.feign"]) //扫描位置
@EnableDiscoveryClient
@SpringBootApplication
class MallMemberApplication
```

### 运行报错

https://www.cnblogs.com/yiMro/p/16018149.html

> member pom.xml

```xml
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-loadbalancer</artifactId>
        </dependency>
```

和上面的文章修改有出入，我只新增了上面的配置