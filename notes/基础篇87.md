## 87、商品服务-API-新增商品-商品新增业务流程分析

商品上架 流程分析 略

## 88、商品服务-API-新增商品-保存SPU基本信息

### 关于JSR303

> [!caution]
>
> - 如果后端提供了满足注解要求的默认值
>   - 前端未提供数据： 直接使用默认值
>   - 前端已提供数据： 覆盖默认值

```kotlin
    @field:NotNull(message = "分类ID不能为空")
    @field:Positive(message = "请提供正确的分类ID")
//  使用 null 还是 默认值 ？如果有默认值 ， 然后前端并为传递这个字段时， 会使用默认值 ， 如果默认值满足了要求，不会报错
    var catalogId: Long = 0L,
//    var catalogId: Long? = null,
```

### 关于事务

> [!caution]
>
> 还需要后续深入研究 https://blog.csdn.net/andy_zhang2007/article/details/83624533

### 新增商品接口

**请求方式：**

```java
POST
```

**请求地址：**

```java
/product/spuinfo/save
```

**请求参数：**

```json
{
	"spuName": "Apple XR",
	"spuDescription": "Apple XR",
	"catalogId": 225,
	"brandId": 12,
	"weight": 0.048,
	"publishStatus": 0,
	"decript": ["https://gulimall-hello.oss-cn-beijing.aliyuncs.com/2019-11-22//66d30b3f-e02f-48b1-8574-e18fdf454a32_f205d9c99a2b4b01.jpg"],
	"images": ["https://gulimall-hello.oss-cn-beijing.aliyuncs.com/2019-11-22//dcfcaec3-06d8-459b-8759-dbefc247845e_5b5e74d0978360a1.jpg", "https://gulimall-hello.oss-cn-beijing.aliyuncs.com/2019-11-22//5b15e90a-a161-44ff-8e1c-9e2e09929803_749d8efdff062fb0.jpg"],
	"bounds": {
		"buyBounds": 500,
		"growBounds": 6000
	},
	"baseAttrs": [{
		"attrId": 7,
		"attrValues": "aaa;bb",
		"showDesc": 1
	}, {
		"attrId": 8,
		"attrValues": "2019",
		"showDesc": 0
	}],
	"skus": [{
		"attr": [{
			"attrId": 9,
			"attrName": "颜色",
			"attrValue": "黑色"
		}, {
			"attrId": 10,
			"attrName": "内存",
			"attrValue": "6GB"
		}],
		"skuName": "Apple XR 黑色 6GB",
		"price": "1999",
		"skuTitle": "Apple XR 黑色 6GB",
		"skuSubtitle": "Apple XR 黑色 6GB",
		"images": [{
			"imgUrl": "https://gulimall-hello.oss-cn-beijing.aliyuncs.com/2019-11-22//dcfcaec3-06d8-459b-8759-dbefc247845e_5b5e74d0978360a1.jpg",
			"defaultImg": 1
			}, {
			"imgUrl": "https://gulimall-hello.oss-cn-beijing.aliyuncs.com/2019-11-22//5b15e90a-a161-44ff-8e1c-9e2e09929803_749d8efdff062fb0.jpg",
			"defaultImg": 0
		}],
		"descar": ["黑色", "6GB"],
		"fullCount": 5,
		"discount": 0.98,
		"countStatus": 1,
		"fullPrice": 1000,
		"reducePrice": 10,
		"priceStatus": 0,
		"memberPrice": [{
			"id": 1,
			"name": "aaa",
			"price": 1998.99
		}]
		}, {
		"attr": [{
			"attrId": 9,
			"attrName": "颜色",
			"attrValue": "黑色"
		}, {
			"attrId": 10,
			"attrName": "内存",
			"attrValue": "12GB"
		}],
		"skuName": "Apple XR 黑色 12GB",
		"price": "2999",
		"skuTitle": "Apple XR 黑色 12GB",
		"skuSubtitle": "Apple XR 黑色 6GB",
		"images": [{
			"imgUrl": "",
			"defaultImg": 0
		}, {
			"imgUrl": "",
			"defaultImg": 0
		}],
		"descar": ["黑色", "12GB"],
		"fullCount": 0,
		"discount": 0,
		"countStatus": 0,
		"fullPrice": 0,
		"reducePrice": 0,
		"priceStatus": 0,
		"memberPrice": [{
			"id": 1,
			"name": "aaa",
			"price": 1998.99
		}]
	}, {
		"attr": [{
			"attrId": 9,
			"attrName": "颜色",
			"attrValue": "白色"
		}, {
			"attrId": 10,
			"attrName": "内存",
			"attrValue": "6GB"
		}],
		"skuName": "Apple XR 白色 6GB",
		"price": "1998",
		"skuTitle": "Apple XR 白色 6GB",
		"skuSubtitle": "Apple XR 黑色 6GB",
		"images": [{
			"imgUrl": "",
			"defaultImg": 0
		}, {
			"imgUrl": "",
			"defaultImg": 0
		}],
		"descar": ["白色", "6GB"],
		"fullCount": 0,
		"discount": 0,
		"countStatus": 0,
		"fullPrice": 0,
		"reducePrice": 0,
		"priceStatus": 0,
		"memberPrice": [{
			"id": 1,
			"name": "aaa",
			"price": 1998.99
		}]
	}, {
		"attr": [{
			"attrId": 9,
			"attrName": "颜色",
			"attrValue": "白色"
		}, {
			"attrId": 10,
			"attrName": "内存",
			"attrValue": "12GB"
		}],
		"skuName": "Apple XR 白色 12GB",
		"price": "2998",
		"skuTitle": "Apple XR 白色 12GB",
		"skuSubtitle": "Apple XR 黑色 6GB",
		"images": [{
			"imgUrl": "",
			"defaultImg": 0
		}, {
			"imgUrl": "",
			"defaultImg": 0
		}],
		"descar": ["白色", "12GB"],
		"fullCount": 0,
		"discount": 0,
		"countStatus": 0,
		"fullPrice": 0,
		"reducePrice": 0,
		"priceStatus": 0,
		"memberPrice": [{
			"id": 1,
			"name": "aaa",
			"price": 1998.99
		}]
	}]
}
```

**响应数据：**

```java
{
	"msg": "success",
	"code": 0
}
```

## 89、商品服务-API-新增商品-保存SKU基本信息

> 具体查看product SpuInfoServiceImpl `saveSpuInfo()`

## 90、商品服务-API-新增商品-调用远程服务保存优惠等信息

### 远程调用前提

- 被调用远程服务

  - 必须上线，放到注册中心中
  - 开启发现功能 

  ```kotlin
  @EnableDiscoveryClient
  @SpringBootApplication
  class MallCouponApplication
  
  fun main(args: Array<String>) {
      runApplication<MallCouponApplication>(*args)
  }
  ```

- 调用远程服务的服务

  - 也在注册中心中
  - 编写接口

  ```kotlin
  // 远程客户端
  // mall_coupon 注册中心的名字
  @FeignClient("mall-coupon")
  interface CouponFeignService {
  
  //    复制的coupon里的CouponController的方法签名
      @RequestMapping("/coupon/coupon/member/list")
      fun memberCoupons(): R
  }
  ```

  - 开启远程调用功能

  ```kotlin
  @EnableFeignClients(basePackages = ["com.vurtnewk.mall.member.feign"]) //开启远程调用功能
  @EnableDiscoveryClient
  @SpringBootApplication
  class MallMemberApplication
  
  fun main(args: Array<String>) {
      runApplication<MallMemberApplication>(*args)
  }
  ```

### 最终代码

> [!note]
>
> 详见
>
> - product
>   - SpuInfoServiceImpl
>   - CouponFeignService
>   - SpuInfoVO
>   - MallProductApplication
> - common
>   - SkuReductionDto
>   - SpuBoundsDto
> - coupon
>   - SkuFullReductionController
>   - SpuBoundsController
>   - SkuFullReductionServiceImpl

## 91、商品服务-API-新增商品-商品保存debug完成

### 合并微服务启动

![image-20250112193736158](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501121937245.png) 

通过Compound （如果没有就点 + 号新增）

### 修改启动占用内存

![image-20250112195044066](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501121950146.png) 

### 启动错误

> openfeign出现错误No Feign Client for loadBalancing defined. Did you forget to include spring-cloud-starter-loadbalancer?

添加依赖

```xml
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-loadbalancer</artifactId>
        </dependency>
```

### 数据库查看未Commit的数据

```sql
SET SESSION TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
```

### Debug 数据

## 92、商品服务-API-新增商品-商品保存其他问题处理

> 修复逻辑和bug  具体看代码提交 

## 93、商品服务-API-商品管理-SPU检索

### spu检索

![image-20250112224003797](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501122240011.png)

**请求方式：**

```java
GET
```

**请求地址：**

```java
/product/spuinfo/list
```

**请求参数：**

```java
{
   page: 1,//当前页码
   limit: 10,//每页记录数
   sidx: 'id',//排序字段
   order: 'asc/desc',//排序方式
   key: '华为',//检索关键字
   catelogId: 6,//三级分类id
   brandId: 1,//品牌id 
   status: 0,//商品状态
}
```

> 分页数据

**响应数据：**

```java
{
	"msg": "success",
	"code": 0,
	"page": {
		"totalCount": 0,
		"pageSize": 10,
		"totalPage": 0,
		"currPage": 1,
		"list": [{

			"brandId": 0, //品牌id
			"brandName": "品牌名字",
			"catalogId": 0, //分类id
			"catalogName": "分类名字",
			"createTime": "2019-11-13T16:07:32.877Z", //创建时间
			"id": 0, //商品id
			"publishStatus": 0, //发布状态
			"spuDescription": "string", //商品描述
			"spuName": "string", //商品名字
			"updateTime": "2019-11-13T16:07:32.877Z", //更新时间
			"weight": 0 //重量

		}]
	}
}
```

### 核心逻辑

```kotlin
override fun queryPageByCondition(params: Map<String, Any>): PageUtils {
        val key = params["key"] as? String
        val catalogId = params["catelogId"] as? String
        val brandId = params["brandId"] as? String
        val status = params["status"] as? String

        return KtQueryChainWrapper(SpuInfoEntity::class.java)
            .and(!key.isNullOrBlank()) {
                it.eq(SpuInfoEntity::id, key).or().like(SpuInfoEntity::spuName, key)
            }
            .eq(!status.isNullOrBlank(), SpuInfoEntity::publishStatus, status)
            .eq(!catalogId.isNullOrBlank(), SpuInfoEntity::catalogId, catalogId)
            .eq(!brandId.isNullOrBlank(), SpuInfoEntity::brandId, brandId)
            .toPage(params)
            .pageUtils()
//            .page(Query<SpuInfoEntity>().getPage(params))
    }
```

### 时间处理

```yaml
  jackson: # 接口返回的JSON里的时间格式处理
    date-format: yyyy-mm-dd HH:mm:ss
```

