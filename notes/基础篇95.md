## 95、仓储服务-API-仓库管理-整合ware服务&获取仓库列表

### 注意点

> - @EnableTransactionManagement 开启事务
>
> - 网关
> - 分页

![image-20250113013551885](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501130135926.png)

## 96、仓储服务-API-仓库管理-查询库存&创建采购需求

![image-20250113020843353](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501130208414.png)

## 97、仓储服务-API-仓库管理-合并采购需求

### 采购简要流程

![image-20250113021106481](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501130211511.png) 

### 查询未领取的采购单

![image-20250113152227002](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501131522034.png)

**请求方式：**

```java
GET
```

**请求地址：**

```java
/ware/purchase/unreceive/list
```

**响应数据：**

```java
{
	"msg": "success",
	"code": 0,
	"page": {
		"totalCount": 0,
		"pageSize": 10,
		"totalPage": 0,
		"currPage": 1,
		"list": [{
			"id": 1,
			"assigneeId": 1,
			"assigneeName": "aa",
			"phone": "123",
			"priority": 1,
			"status": 1,
			"wareId": 1,
			"amount": 22.0000,
			"createTime": "2019-12-12",
			"updateTime": "2019-12-12"
		}]
	}
}
```

#### 核心逻辑

```kotlin
```



### 异常

> org.springframework.web.util.NestedServletException: Handler dispatch failed; nested exception is java.lang.NoClassDefFoundError: Could not initialize class com.baomidou.mybatisplus.extension.plugins.pagination.optimize.JsqlParserCountOptimize

人人查看管理员列表时，报错

原因：common模块引入的mybatis plus和renren的版本不一致导致冲突

解决：

> renren pom.xml

```xml
		<dependency>
			<groupId>com.vurtnewk.mall</groupId>
			<artifactId>mall_common</artifactId>
			<version>1.0-SNAPSHOT</version>
			<exclusions>
				<exclusion>
					<groupId>org.mybatis</groupId>
					<artifactId>mybatis-spring</artifactId>
				</exclusion>
				<exclusion>
					<groupId>com.baomidou</groupId>
					<artifactId>mybatis-plus-boot-starter</artifactId>
				</exclusion>
				<exclusion>
					<groupId>mysql</groupId>
					<artifactId>mysql-connector-java</artifactId>
				</exclusion>
				<exclusion>
					<groupId>commons-lang</groupId>
					<artifactId>commons-lang</artifactId>
				</exclusion>
        <!--版本冲突-->
				<exclusion>
					<artifactId>jsqlparser</artifactId>
					<groupId>com.github.jsqlparser</groupId>
				</exclusion>
				<exclusion>
					<artifactId>mybatis-plus-jsqlparser</artifactId>
					<groupId>com.baomidou</groupId>
				</exclusion>
			</exclusions>
		</dependency>
```

### 合并采购需求

![image-20250113160153783](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501131601816.png)

**请求方式：**

```java
POST
```

**请求地址：**

```java
/ware/purchase/merge
```

**请求参数：**

```java
{
  purchaseId: 1, //整单id
  items:[1,2,3,4] //合并项集合
}
```

> 分页数据

**响应数据：**

```java
{
	"msg": "success",
	"code": 0
}
```

### @Serializable添加

```xml
            <plugin>
                <groupId>org.jetbrains.kotlin</groupId>
                <artifactId>kotlin-maven-plugin</artifactId>
                <configuration>
                    <args>
                        <arg>-Xjsr305=strict</arg>
                    </args>
                    <compilerPlugins>
                        <plugin>spring</plugin>
                        <plugin>kotlinx-serialization</plugin> <!-- 添加序列化插件 -->
                    </compilerPlugins>
                </configuration>
                <dependencies>
                    <dependency>
                        <groupId>org.jetbrains.kotlin</groupId>
                        <artifactId>kotlin-maven-allopen</artifactId>
                        <version>${kotlin.version}</version>
                    </dependency>
                </dependencies>
            </plugin>

        <!-- Kotlinx Serialization JSON 支持 -->
        <dependency>
            <groupId>org.jetbrains.kotlinx</groupId>
            <artifactId>kotlinx-serialization-json</artifactId>
            <version>1.8.0</version> <!-- 替换为最新版本 -->
        </dependency>
```

## 98、仓储服务-API-仓库管理-领取采购单

### 领取采购单

**请求方式：**

```java
POST
```

**请求地址：**

```java
/ware/purchase/received
```

**请求参数：**

```java
[1,2,3,4]//采购单id
```

> 分页数据

**响应数据：**

```java
{
	"msg": "success",
	"code": 0
}
```

使用postman等进行接口测试

### 核心逻辑

```kotlin
    @Transactional
    override fun receivedPurchaseOrder(purchaseIds: List<Long>) {
        if (purchaseIds.isEmpty()) return

        //1、确认当前采购单是新建或者已分配状态
        // 查出参数里，状态满足的采购单
        val purchaseEntities = KtQueryChainWrapper(PurchaseEntity::class.java)
            .`in`(PurchaseEntity::id, purchaseIds)
            .and {
                it.eq(PurchaseEntity::status, WareConstants.PurchaseStatusEnum.CREATED.code)
                    .or().eq(PurchaseEntity::status, WareConstants.PurchaseStatusEnum.ASSIGNED.code)
            }
            .list()
            .map {
                it.status = WareConstants.PurchaseStatusEnum.RECEIVE.code
                it.updateTime = Date()
                it
            }
        //2、改变采购单的状态
        if(purchaseEntities.isEmpty()){
            logInfo("没有符合条件的采购需求")
            throw CustomException("没有符合条件的采购需求")
        }
        this.updateBatchById(purchaseEntities)

        //3、改变采购项的状态
        val purchaseDetailEntities = KtQueryChainWrapper(PurchaseDetailEntity::class.java)
            .`in`(PurchaseDetailEntity::purchaseId, purchaseEntities.map { it.id })
            .list()
            .map {
                it.status = WareConstants.PurchaseDetailStatusEnum.BUYING.code
                it
            }
        if(purchaseDetailEntities.isEmpty()) {
            logInfo("这个采购单下，没有采购需求")
            throw CustomException("这个采购单下，没有采购需求")
        }
        purchaseDetailService.updateBatchById(purchaseDetailEntities)
    }
```

### 异常处理

> 放在了common模块

```kotlin
@RestControllerAdvice
class MallExceptionControllerAdvice {

    /**
     * 用于JSR303校验异常时的数据返回
     */
    @ExceptionHandler(value = [MethodArgumentNotValidException::class])
    fun handleValidException(e: MethodArgumentNotValidException): R {
        val map: MutableMap<String, String?> = HashMap()
        e.bindingResult.fieldErrors.forEach(Consumer { item: FieldError ->
            map[item.field] = item.defaultMessage
        })
        return R.error(BizCodeEnum.VALID_EXCEPTION.code, BizCodeEnum.VALID_EXCEPTION.msg).put("data", map)
    }

    @ExceptionHandler(value = [CustomException::class])
    fun handleCustomException(e: CustomException): R {
        return R.error(BizCodeEnum.VALID_EXCEPTION.code, e.message.toString())
    }

    @ExceptionHandler(value = [Throwable::class])
    fun handleException(e: Throwable): R {
        println(e.message)
        return R.error(BizCodeEnum.UNKNOWN_EXCEPTION.code, BizCodeEnum.UNKNOWN_EXCEPTION.msg)
    }
}
```

> 使用common的模块需要额外加上配置

```kotlin
@EnableDiscoveryClient
@SpringBootApplication(scanBasePackages = ["com.vurtnewk.common","com.vurtnewk.mall.ware"])
class MallWareApplication

fun main(args: Array<String>) {
    runApplication<MallWareApplication>(*args)
}
```

> [!caution]
>
> 如果异常不是RuntimeException，事务不会回滚

## 99、仓储服务-API-仓库管理-完成采购

### 完成采购

**请求方式：**

```java
POST
```

**请求地址：**

```java
/ware/purchase/done
```

**请求参数：**

```java
{
   id: 123,//采购单id
   items: [{itemId:1,status:4,reason:""}]//完成/失败的需求详情
}
```

**响应数据：**

```java
{
	"msg": "success",
	"code": 0
}
```
