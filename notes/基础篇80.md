## 80、商品服务-API-平台属性-查询分组关联属性&删除关联

![image-20250111175131960](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501111751000.png)

### 获取属性分组的关联的所有属性

**请求方式：**

```java
GET
```

**请求地址：**

```java
/product/attrgroup/{attrgroupId}/attr/relation
```

**接口描述：**

获取指定分组关联的所有属性

**响应数据：**

```java
{
  "msg": "success",
  "code": 0,
  "data": [
    {
      "attrId": 4,
      "attrName": "aad",
      "searchType": 1,
      "valueType": 1,
      "icon": "qq",
      "valueSelect": "v;q;w",
      "attrType": 1,
      "enable": 1,
      "catelogId": 225,
      "showDesc": 1
    }
  ]
}
```

```kotlin
    override fun getAttrGrouprelation(attrgroupId: Long): List<AttrEntity> {
        //通过中间表 查询指定attrGroupId的所有attrId
        val idList = KtQueryChainWrapper(AttrAttrgroupRelationEntity::class.java)
            .eq(AttrAttrgroupRelationEntity::attrGroupId, attrgroupId)
            .list()
            ?.mapNotNull {
                it.attrId
            } ?: emptyList()

        //如果没有查询到 直接返回空列表
        if (idList.isEmpty()) return emptyList()

        return KtQueryChainWrapper(AttrEntity::class.java)
            .`in`(AttrEntity::attrId, idList)
            .list()
    }
```

### 删除属性与分组的关联关系

**请求方式：**

```java
POST
```

**请求地址：**

```java
/product/attrgroup/attr/relation/delete
```

**请求参数：**

```java
[{"attrId":1,"attrGroupId":2}]
```

**响应数据：**

```java
{
	"msg": "success",
	"code": 0
}
```

#### 核心内容

```kotlin
    /**
     * 批量删除关联关系
     * 需要的sql
     * DELETE FROM pms_attr_attrgroup_relation WHERE ((attr_id = ? AND attr_group_id = ?) OR (attr_id = ? AND attr_group_id = ?))
     * DELETE FROM pms_attr_attrgroup_relation WHERE (attr_id =? AND attr_group_id=?)
     */
    override fun deleteRelation(attrGroupRelationVOList: List<AttrGroupRelationVO>) {
        //方式一: 通过ktUpdateChainWrapper来生成sql
//        val ktUpdateChainWrapper = KtUpdateChainWrapper(AttrAttrgroupRelationEntity::class.java)
//        attrGroupRelationVOList.forEachIndexed { index, attrGroupRelationVO ->
//            if (index == 0) {
//                ktUpdateChainWrapper.and {
//                    it.eq(AttrAttrgroupRelationEntity::attrId, attrGroupRelationVO.attrId)
//                        .eq(AttrAttrgroupRelationEntity::attrGroupId, attrGroupRelationVO.attrGroupId)
//                }
//            } else {
//                ktUpdateChainWrapper.or{
//                    it.eq(AttrAttrgroupRelationEntity::attrId, attrGroupRelationVO.attrId)
//                        .eq(AttrAttrgroupRelationEntity::attrGroupId, attrGroupRelationVO.attrGroupId)
//                }
//            }
//        }
//        ktUpdateChainWrapper.remove()
        //方式二： 通过SQL语句
        //为了 Dao 只操作 Entity (PO) ，而不直接操作 VO
        val list = attrGroupRelationVOList.map {
            val attrAttrgroupRelationEntity = AttrAttrgroupRelationEntity()
            BeanUtils.copyProperties(it,attrAttrgroupRelationEntity)
            attrAttrgroupRelationEntity
        }
        mAttrAttrgroupRelationDao.deleteRelation(list)
    }
```

```xml
    <delete id="deleteRelation">
        DELETE
        FROM `pms_attr_attrgroup_relation`
        WHERE
            <foreach collection="entities" item="item" separator=" OR ">
                (attr_id = #{item.attrId} AND attr_group_id = #{item.attrGroupId})
            </foreach>
    </delete>
```

## 81、商品服务-API-平台属性-查询分组未关联的属性

**请求方式：**

```java
GET
```

**请求地址：**

```java
/product/attrgroup/{attrgroupId}/noattr/relation
```

**接口描述：**

获取属性分组里面还没有关联的本分类里面的其他基本属性，方便添加新的关联

**请求参数：**

```java
{
   page: 1,//当前页码
   limit: 10,//每页记录数
   sidx: 'id',//排序字段
   order: 'asc/desc',//排序方式
   key: '华为'//检索关键字
}
```

> 分页数据

**响应数据：**

```java
{
	"msg": "success",
	"code": 0,
	"page": {
		"totalCount": 3,
		"pageSize": 10,
		"totalPage": 1,
		"currPage": 1,
		"list": [{
			"attrId": 1,
			"attrName": "aaa",
			"searchType": 1,
			"valueType": 1,
			"icon": "aa",
			"valueSelect": "aa;ddd;sss;aaa2",
			"attrType": 1,
			"enable": 1,
			"catelogId": 225,
			"showDesc": 1
		}]
	}
}
```

### 核心逻辑

```kotlin
    /**
     * 指定属性 attrGroupId 下没有被关系的属性
     * 1. pms_attr_group 表和 pms_attr 表、 catelog_id 要一致
     * 2. 且 不在 pms_attr_attrgroup_relation 表中 （也就是没有和其它分组进行关联）
     */
    override fun attrNotRelation(params: Map<String, Any>, attrGroupId: Long): PageUtils {
        // 根据 attrGroupId 在 pms_attr_group 里获取 catelog_id
        // 根据 pms_attr 获取 catelog_id 的数据
        // 不要 pms_attr_attrgroup_relation 中

        // 1. 根据 attrGroupId 在 pms_attr_group 里获取 catelog_id
        val attrGroupEntity = KtQueryChainWrapper(AttrGroupEntity::class.java)
            .eq(AttrGroupEntity::attrGroupId, attrGroupId)
            .one()
        // 2. 当前分类 catelog_id 的所有分组 的ID
        val idsList = KtQueryChainWrapper(AttrGroupEntity::class.java)
            .eq(AttrGroupEntity::catelogId, attrGroupEntity.catelogId)
            .list()//这里肯定不可能为空，两次都是通过AttrGroup来查的
            .map {
                it.attrGroupId
            }
        // 3. 查询这些分组 已经关联的 属性
        val attrIdList = KtQueryChainWrapper(AttrAttrgroupRelationEntity::class.java)
            .`in`(AttrAttrgroupRelationEntity::attrGroupId, idsList)
            .list()//这里可能为空，有可能所有分组都还没关联属性
            ?.mapNotNull {
                it.attrId
            }

        //4.最终去查询符合条件的属性
        val key = params["key"] as? String
        return KtQueryChainWrapper(AttrEntity::class.java)
            .eq(AttrEntity::catelogId, attrGroupEntity.catelogId)
            .eq(AttrEntity::attrType, AttrEnum.ATTR_TYPE_BASE.code)//销售属性没有分组，所以不用关联
            .notIn(!attrIdList.isNullOrEmpty(), AttrEntity::attrId, attrIdList) //不为null或空时，查的ID不能是attrIdList里的
            //key 不是 空时添加模糊查询条件
            .and(!key.isNullOrBlank()) {
                it.eq(AttrEntity::attrId, key).or().like(AttrEntity::attrName, key)
            }
            .page(Query<AttrEntity>().getPage(params))
            .pageUtils()
    }
```

## 82、商品服务-API-平台属性-新增分组与属性关联

**请求方式：**

```java
POST
```

**请求地址：**

```java
/product/attrgroup/attr/relation
```

**请求参数：**

```java
[{
  "attrGroupId": 0, //分组id
  "attrId": 0, //属性id
}]
```

**响应数据：**

```java
{
	"msg": "success",
	"code": 0
}
```

### 核心逻辑

使用自带的批量插入

> AttrAttrgroupRelationServiceImpl

```kotlin
    @Transactional
    override fun saveBatch(attrGroupRelationVOList: List<AttrGroupRelationVO>) {
        val list = attrGroupRelationVOList
            .map {
                val relationEntity = AttrAttrgroupRelationEntity()
                BeanUtils.copyProperties(it, relationEntity)
                relationEntity
            }
        this.saveBatch(list)
    }
```

