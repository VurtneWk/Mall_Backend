## 80、商品服务-API-平台属性-查询分组关联属性&删除关联

![image-20250111175131960](https://gitee.com/vurtnewk/typora-image/raw/master/images03/202501111751000.png)

### 获取属性分组的关联的所有属性

**请求方式：**

```java
GET
```

**请求地址：**

```java
/product/attrgroup/{attrgroupId}/attr/relation
```

**接口描述：**

获取指定分组关联的所有属性

**响应数据：**

```java
{
  "msg": "success",
  "code": 0,
  "data": [
    {
      "attrId": 4,
      "attrName": "aad",
      "searchType": 1,
      "valueType": 1,
      "icon": "qq",
      "valueSelect": "v;q;w",
      "attrType": 1,
      "enable": 1,
      "catelogId": 225,
      "showDesc": 1
    }
  ]
}
```

```kotlin
    override fun getAttrGrouprelation(attrgroupId: Long): List<AttrEntity> {
        //通过中间表 查询指定attrGroupId的所有attrId
        val idList = KtQueryChainWrapper(AttrAttrgroupRelationEntity::class.java)
            .eq(AttrAttrgroupRelationEntity::attrGroupId, attrgroupId)
            .list()
            ?.mapNotNull {
                it.attrId
            } ?: emptyList()

        //如果没有查询到 直接返回空列表
        if (idList.isEmpty()) return emptyList()

        return KtQueryChainWrapper(AttrEntity::class.java)
            .`in`(AttrEntity::attrId, idList)
            .list()
    }
```

### 删除属性与分组的关联关系

**请求方式：**

```java
POST
```

**请求地址：**

```java
/product/attrgroup/attr/relation/delete
```

**请求参数：**

```java
[{"attrId":1,"attrGroupId":2}]
```

**响应数据：**

```java
{
	"msg": "success",
	"code": 0
}
```

#### 核心内容

```kotlin
    /**
     * 批量删除关联关系
     * 需要的sql
     * DELETE FROM pms_attr_attrgroup_relation WHERE ((attr_id = ? AND attr_group_id = ?) OR (attr_id = ? AND attr_group_id = ?))
     * DELETE FROM pms_attr_attrgroup_relation WHERE (attr_id =? AND attr_group_id=?)
     */
    override fun deleteRelation(attrGroupRelationVOList: List<AttrGroupRelationVO>) {
        //方式一: 通过ktUpdateChainWrapper来生成sql
//        val ktUpdateChainWrapper = KtUpdateChainWrapper(AttrAttrgroupRelationEntity::class.java)
//        attrGroupRelationVOList.forEachIndexed { index, attrGroupRelationVO ->
//            if (index == 0) {
//                ktUpdateChainWrapper.and {
//                    it.eq(AttrAttrgroupRelationEntity::attrId, attrGroupRelationVO.attrId)
//                        .eq(AttrAttrgroupRelationEntity::attrGroupId, attrGroupRelationVO.attrGroupId)
//                }
//            } else {
//                ktUpdateChainWrapper.or{
//                    it.eq(AttrAttrgroupRelationEntity::attrId, attrGroupRelationVO.attrId)
//                        .eq(AttrAttrgroupRelationEntity::attrGroupId, attrGroupRelationVO.attrGroupId)
//                }
//            }
//        }
//        ktUpdateChainWrapper.remove()
        //方式二： 通过SQL语句
        //为了 Dao 只操作 Entity (PO) ，而不直接操作 VO
        val list = attrGroupRelationVOList.map {
            val attrAttrgroupRelationEntity = AttrAttrgroupRelationEntity()
            BeanUtils.copyProperties(it,attrAttrgroupRelationEntity)
            attrAttrgroupRelationEntity
        }
        mAttrAttrgroupRelationDao.deleteRelation(list)
    }
```

```xml
    <delete id="deleteRelation">
        DELETE
        FROM `pms_attr_attrgroup_relation`
        WHERE
            <foreach collection="entities" item="item" separator=" OR ">
                (attr_id = #{item.attrId} AND attr_group_id = #{item.attrGroupId})
            </foreach>
    </delete>
```

